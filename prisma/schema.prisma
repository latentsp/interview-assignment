// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model users {
  id             String        @id @default(uuid())
  email          String        @unique
  name           String?
  argyle_user_id String?       @unique
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt
  user_tokens    user_tokens[]
  incomes        incomes[]
  paystubs       paystubs[]
}

model user_tokens {
  id                     String   @id @default(uuid())
  user_id                String
  provider               String // "ARGYLE"
  external_connection_id String? // Argyle user ID
  provider_metadata      String? // JSON string (SQLite doesn't support JSON)
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt
  users                  users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([provider, external_connection_id])
}

model incomes {
  id                  String     @id @default(uuid())
  user_id             String
  name                String? // Employer name
  source              String? // "FORM_W2", "FORM_1099"
  provider_id         String? // "ARGYLE"
  external_source_id  String? // Argyle item ID
  external_account_id String? // Argyle account ID
  status              String     @default("IN_PROGRESS")
  created_at          DateTime   @default(now())
  updated_at          DateTime   @updatedAt
  users               users      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  paystubs            paystubs[]

  @@unique([user_id, external_source_id])
  @@index([user_id])
  @@index([external_account_id])
}

model paystubs {
  id            String    @id @default(uuid())
  user_id       String
  income_id     String
  external_id   String // Argyle paystub ID
  gross_pay     Float?
  net_pay       Float?
  deductions    Float?
  taxes         Float?
  hours         Float?
  pay_date      DateTime?
  period_start  DateTime?
  period_end    DateTime?
  employer_name String?
  provider      String    @default("argyle")
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  users         users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  incomes       incomes   @relation(fields: [income_id], references: [id], onDelete: Cascade)

  @@unique([user_id, external_id])
  @@index([user_id])
  @@index([income_id])
}

model webhook_events {
  id           String    @id @default(uuid())
  provider     String // "ARGYLE"
  event        String? // "paystubs.added", etc.
  payload      String? // JSON string
  received_at  DateTime  @default(now())
  processed_at DateTime?
  failed_at    DateTime?
  error        String?
}
